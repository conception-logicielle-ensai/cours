---
url: /docs/kubernetes/
title: üõû D√©ploiement avec Kubernetes 
---

Cette partie pr√©sente des tenants et aboutissants du d√©ploiement applicatif, avec une application a l'h√©bergement cloud via **`kubernetes`**.

Les exemples sont bas√©s sur l'application h√©berg√©e ici : [https://frontend-conception-logicielle.kub.sspcloud.fr/](https://frontend-conception-logicielle.kub.sspcloud.fr/)

Api h√©berg√©e ici : [https://backend-conception-logicielle.kub.sspcloud.fr](https://backend-conception-logicielle.kub.sspcloud.fr)

> Le code source de l'application est disponible directement dans le projet d'architecture exemple : [https://github.com/conception-logicielle-ensai/archi-exemple](https://github.com/conception-logicielle-ensai/archi-exemple)


## Pr√©ambule : H√©bergement traditionnel d'une application

Avant de s'int√©resser a ce que nous permet Kubernetes, on pr√©cise ce qui permet h√©berger une application ou un site web.

### Environnement d'execution
Il vous faut un **environnement d'execution** de votre application. C'est a dire un support sur lequel on peut lancer votre application.

Cela inclut l'installation des d√©pendances, la configuration des services et la gestion des fichiers applicatifs.

Cela peut √™tre par exemple : 
- Un ordinateur avec python d'install√©.
- Une machine virtuelle (machine install√©e sur un ordinateur, on peut en installer plusieurs)
- Un serveur (qui est un ordinateur), sur lequel est install√© un **engine** docker, ce qui permet de lancer des applications sous forme de conteneur.

### Routage et exposition de votre application

Une fois que votre application tourne sur un environement d'execution, il faut la rendre accessible a l'ext√©rieur.

Il faut pour cela comprendre comment fonctionne l'acc√®s a une machine depuis une url.

- Pour l'acc√®s √† une url donn√©e : https://google.com

Il existe un ensemble de serveurs DNS qui permettent d'apparier les urls avec des adresses IP, en effet on ne pourrait pas facilement retenir des adresses IP. 

Les adresses IP correspondent a ce qu'on appelle des **Load balancer** ou des **serveurs**. En simplifiant un peu, cela correspond a une IP publique d'acc√®s a votre service (machine, cluster, vm ou autre..)

Il faut finalement que votre serveur / machine / cluster accepte l'acc√®s sur le port, tous les ports sont ferm√©s par d√©faut.

**En bref**:

Une fois l'application install√©e, elle doit √™tre accessible aux utilisateurs via le r√©seau. 
Cela implique la configuration d'un serveur (uvicorn ou serveur web statique (pour simplifier on utilise vite ici)). 
L'attribution d'une adresse IP et l'ouverture des ports n√©cessaires pour permettre la communication avec les clients se configure au niveau de l'environnement d'execution, on parle parfois de **parefeu applicatif**.

> Il existe d'autres notions : scalabilit√©, routage, ...

## Pr√©ambule diff√©rentes formes d'h√©bergements

## Architecture de Kubernetes : un standard d'architecture d'h√©bergement cloud

Kubernetes propose une solution d'architecture pour administrer des serveurs qui h√©bergent des applications sous forme de conteneurs.

Kubernetes permet (entre autres):

- D'executer des conteneurs sur des serveurs a la demande
- D'associer ces traitements avec de la persistence
- Une couche r√©seau interne au cluster de machines (connexion entre conteneurs isol√©s)
- Proposer une typologie d'ordonnancement, de red√©marrage et de mise a jour : Rollout..


L'id√©e ? 

1. On part du simple concept de pouvoir lancer des processus isol√©s sur une machine. 
2. On administre nos diff√©rents serveurs avec une architecture Master / slave
3. On g√®re les demandes c√¥t√© master et on ordonnance les traitements c√¥t√© slave
4. On suit l'√©tat du cluster entre la partie demande et la partie executante.

## Utilisation d'un cluster kubernetes

L'utilisation d'un cluster Kubernetes repose sur la communication avec un **API server**. Il s'agit d'une API qui attend des objets dans un format bien pr√©cis pour ensuite √™tre int√©gr√©s.

L'API server fonctionne avec un superset de JSON, le Yaml.

On pr√©conisera, dans le cadre du cours, d'utiliser l'utilitaire en ligne de commande `kubectl` qui permet de simplifier l'utilisation de l'API kubernetes.

> Remarque les CLI sont des outils tr√®s importants qui peuvent grandement simplifier votre travail en fonction des technologies:  maintenance base de donn√©es, apis √©prouv√©es...

Exemple de contrat d'un Pod: 

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: hello-world-pod
spec:
  containers:
  - name: hello-world-container
    image: ragatzino/backend-demo-conception-logicielle:latest
    ports:
    - containerPort: 8000
```

> Ce yaml d√©crit le contrat d'un Pod. Nous verrons cela dans quelques instants.

**L'application de cette demande au cluster nous permet de lancer un processus sur un des serveurs du cluster.**


Kubernetes permet d'installer des applications a la demande, via l'utilisation d'une API pour d√©ployer des **ressources** sur un cluster. 

Ces ressources correspondent a des applicatifs **deploiement**, des expositions r√©seau **ingress/service** ou des √©l√©ments de configuration **configmap** par exemple.

Comme toute API bien constitu√©e, elle n√©cessite une authentification et n'est pas forc√©ment accessible partout.


## Ressources d'un cluster

![ressources d'un cluster](/images/kube/Kubernetes_Resources.png)

Dans cette partie on va pr√©senter quelques ressources que vous pourrez utiliser sur le cluster, bien d'autres existent r√©pondant chacunes a des besoins sp√©cifiques : 

- Gestion de la resilience et de l'ordonnancement: **deployment**, **statefulSet**, **cronjob**
- Configuration applicatives : **configmap** **secret**
- Routage r√©seau: **ingress**, **service**
Plus loin :
- Droits d'acc√®s √† vos ressources : **role**, **rolebinding**, **serviceaccount**
- Persistence des donn√©es: **persistentvolume**, **persistentvolumeclaim**

> Remarque, il en existe une myriade d'autres

Nous allons nous limiter pour les usages du cours a 4 ressources: 
- Deployment : Lancer des processus conteneuris√©s **pod**, les r√©pliquer, d√©finir une strat√©gie de mise a jour
- Service : Permettre l'acc√®s a des processus a l'int√©rieur du cluster, ou leur donner une adresse IP
- Ingress : Mettre en place une entr√©e DNS, et un routage vers un service en HTTP depuis l'ext√©rieur du cluster.
- Configmap: Permettre la cr√©ation de fichiers de configuration et l'injection de variables d'environnements a l'int√©rieur de nos conteneurs.


### Pod : la brique unitaire contenant un/des conteneur(s)

![pod](/images/kube/pod.jpg)

Un pod est le plus petit concept Kubernetes et correspond (en gros) √† un ensemble de conteneurs (souvent un seul) qui fonctionnent ensemble et se partagent les ressources notamment le r√©seau. Pour en savoir plus sur les concepts kubernetes, √ßa commence ici : https://kubernetes.io/docs/concepts/.

Dans notre cas on lancera un seul conteneur par "Pod", donc cela sera √©quivalent a une instance de votre application <=> un `docker run`.

> Probl√®me si il plante, le processus n'est pas relanc√© donc en g√©n√©ral on utilise pas la ressource Pod telle qu'elle.

### Deployment : Orchestration des pods - red√©marrer, mettre a jour..

### Configmap: externaliser la configuration, introduire des variables d'environnement dans les conteneurs

### Service

![service](/images/kube/service.gif)


### Ingress
![ingress](/images/kube/ingress.png)


## TP : Mise en place de vos applications sur les plateformes kuberentes du SSPCloud

Le sspcloud propose un api server ouvert au sein du cluster kubernetes SSPCloud √† ces utilisateurs.
Ce service est un service a faible support, seulement pour des usages de poc, pas de donn√©es sensibles, pas de garantie de service, toutefois cela convient tout a fait pour les exp√©rimentations et l'h√©bergement de projets informatiques ENSAI.

Pour la mise en place, il nous faut un service qui peut acc√©der au cluster et donc qui est h√©berg√© sur le cluster (puisque l'api n'est accessible que depuis le cluster).

Le SSPCloud met a disposition des services qui vous permettent d'instancier des applications sur le cluster, notamment des services de type "plateforme de d√©veloppement" : 
- VScode
- RStudio

Pour le besoin du d√©ploiement il faudra instancier un VSCode python et lui ajouter dans sa configuration (avant de lancer le service) un role **admin** (**onglet role**)