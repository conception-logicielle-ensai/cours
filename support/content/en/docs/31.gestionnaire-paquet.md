---
url: /docs/gestionnaire-de-package/
title: üì¶ Gestionnaire de package, partage de code, industrialisation
---

Ce cours pr√©sente comment utiliser, mettre en place et partager un environnement de code fonctionnel. Cela assure la portabilit√© de votre application pour que l'on puisse l'utiliser ailleurs que sur votre poste. 
> https://coder.com/blog/it-works-on-my-machine-explained

Pour information : Les exemples pr√©sent√©s dans le cours seront disponibles ici : [https://github.com/conception-logicielle-ensai/exemples-cours/tree/main/cours-3](https://github.com/conception-logicielle-ensai/exemples-cours/tree/main/cours-3) 


### Accroche

Depuis un terminal, faites les commandes suivantes :
- `pip install helloensai`
- `python3 -m helloensai`



<details><summary  class="reponse" ><b> Que s'est il pass√© ? </b></summary>
<p>

- Vous avez t√©l√©charg√© un package avec un gestionnaire de paquet : `pip`
- Ce package a ensuite √©t√© import√© et utilis√© directement en ligne de commande via python3, install√© sur votre machine
- Il a execut√© du code python : un print dans votre console.

Optionnel: Faire en sorte de changer l'output du lancement de la commande `python3 -m helloensai` a partir du message dans la console.

</p></details>

## Interpr√©teur/Compilateur

<img src="/images/portabilite/interpretervscompiler.webp">

Python appartient √† la cat√©gorie des langages interpr√©t√©s (tout comme Javascript et R, par exemple).  
Un langage interpr√©t√© poss√®de un interpr√©teur (on parle aussi de `runtime`)
Pour ex√©cuter un code d'un langage interpr√©t√©, il faut 2 choses :

- Le code source √† ex√©cuter : votre fichier `main.py` par exemple
- Un interpr√©teur : Pour python, il s'agit de la commande `python` (`python3` sur certains syst√®mes pour le distinguer de python 2, `python.exe` sur certains syst√®mes d'exploitation inf√©rieurs)

Pour v√©rifier que l'interpr√©teur `python` est bien disponible sur le syst√®me, on peut lancer la commande

```python
python --version
python3 --version
```

> **Remarque** : il peut √™tre disponible sur votre syst√®me mais pas d√©fini dans un endroit connu du syst√®me voir : https://medium.com/towards-data-engineering/understanding-the-path-variable-in-linux-2e4bcbe47bf5

> **Sidequest** : si vous vous demandez o√π `python` est install√©, vous pouvez utiliser la commande `which` (ou `where` pour les syst√®mes Windows)

<div class="alert alert-info">
  <strong>Pour aller plus loin : Compilateur</strong> <br/> 

Pour les languages compil√©s, il faut un compilateur qui nous permet depuis notre language a un autre language, souvent de plus bas niveau, executable soit directement par la machine soit par un autre interpr√©teur.

Pour python, on entend souvent parler de cython : <a href="https://cython.org/">"https://cython.org/"</a>
</div>

<br />

<br />

<div class="alert alert-info">
  <strong>Pour aller plus loin : Transpileur </strong> <br/> 
   Il existe √©galement des transpileurs, pour convertir des languages en autres languages : ex pour javascript : <a href="https://fr.javascript.info/polyfills"> https://fr.javascript.info/polyfills </a>
</div>

## Environnement d'execution : runtime

> Cette partie s'attele a pr√©senter ce qu'on appelle l'environnement d'execution. 

L'environnement d'execution, est l'ensemble des param√®tres constituant le contexte d'execution du code:
- L'OS et les fonctions noyau li√©es (puisque les fonctions des programmes s'appuyent dans leur coeur a des fonctions noyau)
- Les librairies / modules install√©s
- Pour la version de python
- La configuration du code

### Pr√©ambule : Qu'est ce qu'un gestionnaire de paquets

Lorsque vous voulez travailler avec des fichiers informatiques, les gestionnaires de paquets sont l√† pour vous.

Ils permettent :

- d'installer/mettre √† jour/d√©sinstaller des logiciels/outils/code.

Il en existe une Myriade, pour diff√©rents usages, languages.
- `apt`, `snap` pour l'installation de paquet *debian* de mani√®re simplifi√©e
- `chocolatey` `scoop` `brew` pour l'installation de logiciels *MacOSX* et *Windows*
- `pip` `poetry` pour l'installation de modules *python*.
- `npm` `yarn` pour l'installation de packages *javascript*
- `maven` `gradle` pour l'installation de packages *java*


Il faut en g√©n√©ral pour d√©finir un gestionnaire de paquets : 
- Une norme sur le format partag√© (.whl, .tar, ...)
- Une d√©finition d'un standard pour un h√©bergeur : `pypi.org` `dockerhub` ... Cela permet d'h√©berger soit m√™me et de partager sur des h√©bergeurs
- Une d√©finition sur le mode de r√©cup√©ration du format a partir d'un serveur central.


### Qu'est ce que pip

**pip** c'est un gestionnaire de paquets pour python

C'est l'installeur de premier choix quand il s'agit d'ajouter des d√©pendances (modules) √† un projet python.

Il s'utilise principalement pour l'installation ou la desinstallation de module sur votre syst√®me.
```
pip uninstall <package>
pip install <package>
```

<a href="https://pip.pypa.io/en/stable/cli/pip_install/">
Lien vers la r√©f√©rence de la commande
</a>

```
pip uninstall <package>
```

<a href="https://pip.pypa.io/en/stable/cli/pip_uninstall/">
Lien vers la r√©f√©rence de la commande
</a>

**Tout cela avec des petites verifications pour √©viter de t√©l√©charger les mauvaises d√©pendances**

> Remarque la commande peut √©galement √™tre pip3 selon votre environnement.

### Modules et d√©pendance

<img style="max-width:40%;" src="https://imgs.xkcd.com/comics/dependency.png" />

> Source https://xkcd.com/2347/

- Module : Un module Python est un fichier contenant du code Python (fonctions, classes, variables) pour structurer et r√©utiliser le code. On peut l'importer avec import.
- D√©pendance : Une d√©pendance est une biblioth√®que externe n√©cessaire √† un projet, comme matplotlib pour cr√©er des graphiques, requests pour faire des requetes http, psycopg2 pour faire des connexions a des bases de donn√©es postgresql...

> Fonctionnellement, a part le contrat d'interface sur l'import, le fonctionnement est √©quivalent, une fois l'import effectu√©.


## Wheel : Le format de r√©f√©rence


Lorsque vous installez des packages par l'ext√©rieur vous utilisez d√©j√† probablement des fichiers wheel ou `.whl`.

Une wheel est essentiellement un zip, ou tar qui a un nom qui peut √™tre pars√© par pip pour lui permettre de l'installer de mani√®re adapt√©e sur votre environnement cible.

Regardez plut√¥t : `{dist}-{version}(-{build})?-{python}-{abi}-{platform}.whl`

> Exemple : <a href="https://files.pythonhosted.org/packages/70/8e/0e2d847013cb52cd35b38c009bb167a1a26b2ce6cd6965bf26b47bc0bf44/requests-2.31.0-py3-none-any.whl">`requests-2.31.0-py3-none-any.whl`</a>

> Ce qui donne: `{requests}-{2.31.0}-{py3}-{none}-{any}`

Ce genre de sp√©cification est commune a tous les languages dignes de ce noms, puisqu'harmoniser un mode de livraison pour un gestionnaire de paquets harmonis√©s et coh√©rents, cela permet une compatibilit√© assur√©e entre les diff√©rents outils qui les utilisent.
<div class="alert alert-info">
  <strong>Pour aller plus loin : lisez de la doc, c'est bien</strong> <br/> 

Les PEP ou Python Enhancement Proposal sont les √©volutions et propositions d'√©volutions du language.

Les principales propositions d'am√©liorations de python qui concernent le packaging sont les suivantes :

Comment packager ? => Wheels : [PEP 427](https://peps.python.org/pep-0427/).

Comment sont construit les numeros de version. Par quelle s√©mantique ? => [PEP 440](https://peps.python.org/pep-0440/) 

D√©finir les d√©pendances d'un package pour permettre la r√©solution des d√©pendances mutuelles : [PEP 508](https://peps.python.org/pep-0508/)

Comment build ? [PEP 517](https://peps.python.org/pep-0517)

Index du "tuto" Pypi pour construire et d√©ployer un livrable : [**Build and publish section**](https://packaging.python.org/en/latest/guides/section-build-and-publish/)

</div>


## Isolation des environnements d'execution : **Environnements virtuels**

<img style="max-width:60%;" src="/images/portabilite/python-virtualenv-project-structure.jpg"/>

Pour une isolation des paquets install√©s, et ne pas utiliser tout ce qui existe d√©j√† sur un poste, python permet l'utilisation d'environnements virtuels (virtualenv ou venv).

Ils s'installent au travers du module venv ex :

`python3 -m venv ./venv`

> Cela installe un environnement dans le sous dossier ./venv par rapport au terminal executant le module.

> Note: cet environnement ne doit pas √™tre versionn√© et donc votre gitignore doit bien le g√©rer.

Une fois mis en place, vous pouvez le lancer en utiliser la commande en fonction de l'OS:

| Environnement | Terminal   | commande                       |
| ------------- | ---------- | ------------------------------ |
| MacOs         | bash       | `source <venv>/bin/activate`   |
| Linux         | bash       | `source <venv>/bin/activate`   |
| Windows       | cmd.exe    | ` <venv>\Scripts\activate.bat` |
| Windows       | powershell | ` <venv>\Scripts\Activate.ps1` |

**diff√©rents moyens v√©rifier que vous √™tes dans un venv**
    - pip list --local (il n'y a pas grand chose)
    - Vous avez maintenant une parenth√®se vous indiquant que vous √™tes bien dans votre venv dans votre terminal
    - consulter l'interpreteur python dans votre vscode

üí• Attention √† ne pas le versionner toutefois, r√©ferez vous au .gitignore du chapitre git pour plus d'informations

üèÅ maintenant vous pouvez mettre en place l'environnement via pip install -r requirements.txt par exemple
<div class="alert alert-info">
  <strong>Pour aller plus loin : les venvs packag√©s</strong> <br/> 

Une solution classique pour un statisticien est d'utiliser l'environnement virtuel **conda**, il propose un gestionnaire de package integr√© dans un environnement integr√© pr√™t a l'emploi pour le statisticien.

Par exemple il y a le package **pandas** tr√®s utilis√© pour le travail sur des dataframe.

Cela peut notamment √™tre utile dans des environnements contraints de passer par des venvs packag√©s afin de pouvoir travailler librement avec des outils rendus portables par le mode de livraison de **conda**

Documentation ici : https://docs.anaconda.com/getting-started/
</div>



## Canoniser l'environnement d'execution


<img src="/images/portabilite/requirements.png"/>

### Pip et un fichier canonique : *requirements.txt*

Pour mieux partager un environnement qui permet de faire tourner le code,
**pip** propose de sanctuariser les d√©pendances dans un fichier **requirements.txt**. C'est l'√©quivalent des fichiers `package.json` en Javascript (npm), `pom.xml` (Java / maven) ...

Exemple de fichier requirements.txt: 
```
fastapi
uvicorn
requests
pytest==5.6.7
selenium==1.0.2
flake8
```

Ce fichier permet de simplifier l'installation des d√©pendances en les regroupant dans un fichier, on peut ensuite demander aux utilisateurs/d√©veloppeurs de faire : 

```
pip install -r requirements.txt
```

**Le fichier requirements.txt doit √™tre versionn√© avec votre code sur git**

> Bien √©videmment, cela est pertinent a condition d'√™tre dans un environnement virtuel nu

**Remarque**: On peut √©galement copier un environnement d'execution fonctionnel a partir de la fonction `pip freeze`

```
pip freeze > requirements.txt
```


> Remarque, pip freeze ne fait que des op√©rations tr√®s basiques (lister l'environnement et le sortir dans un message). Il faut donc soit partir d'un environnement d'abord propre (environnement virtuel puis installation de toutes les d√©pendances), ou utiliser une autre librairie 


<div class="alert alert-info">
  <strong>Pour aller plus loin</strong> <br/> 
Il existe un linter qui permet de g√©n√©rer a partir d'une base de code, une approximation du fichier requirements.txt lien vers la documentation <a href="https://pypi.org/project/pipreqs/">https://pypi.org/project/pipreqs/</a>
</div>


### Poetry : une alternative s√©rieuse √† pip simplifiant la gestion des d√©pendances

> https://github.com/python-poetry/poetry

Projet plus r√©cent, r√©pondant a des besoins d'usage non couverts/ mal couverts par pip.

Plusieurs limites existent dans l'utilisation de pip pour un projet de taille r√©elle :

- Gestion des conflits dans l'installation de packages
- Mauvaise gestion des versions de python // paquets
- Praticit√© de la r√©alisation de package sur Pypi
- Gestion fine des d√©pendances pour les environnements d'execution du code (on ne veut pas les d√©pendances li√©es au tests ou a des lignes de commandes qu'on souhaite lancer sur le projet par exemple)
- Gestion des venv pour le projet par rapport aux pr√©requis (version de python etc..)
- Perennit√© dans l'installation de package figeant dans le temps une version fonctionnelle du code.

Ici, poetry int√®gre les notions de versionning, de versions courantes fonctionnelles et cr√©e un lien entre packages et environnement virtuel o√π l'on execute, ce qui limite naturellement quelques eceuils.

Pour ce qui est du packaging, poetry est un facilitateur dans la mise en place de la configuration pour le d√©ploiement de package. Tout est dans un fichier qui est le m√™me que le fichier de versionning du projet, mais √©galement tout s'effectue d'un seul coup et avec un seul outil.

Pour d√©marrer il faut l'installer
```
pip install poetry
```

et pour d√©marrer une config pour poetry : 
```
poetry init
```

Ensuite pour ajouter des package a un projet poetry :
et pour d√©marrer une config pour poetry : 
```
poetry add requests
```

Poetry fonctionne avec un fichier `pyproject.toml` qui est bien plus complexe que le simple fichier `requirements.txt`. C'est plus propre et cela vous permet d'administrer en fonction des versions de python les installation et les environnements virtuels a construire dans le projet. 

> Vous √™tes libre dans le choix du gestionnaire de package (un autre √©galement : pipenv ), mais vous devrez respectez la r√®gle suivante : votre code devra pouvoir √™tre r√©cup√©r√© et lanc√© de mani√®re explicite (quelles commandes permettent d'arriver a un environnement fonctionnel dans le fichier **README.md** dans une section d√©di√©e)

## Creation d'un package

Les gestionnaires de paquets permettent a la fois d'utiliser des paquets existants, mais vous le devinez bien, il est possible d'en cr√©er vous m√™me.

Les d√©pots de packets peuvent √™tre :

- priv√©s - c'est le cas dans les entreprises en g√©n√©ral
- publics :
  - c'est le cas du d√©p√¥t pypi https://pypi.org/ , vers lequel pointe par d√©faut une installation de pip.
  - mais √©galement du d√©p√¥t de test : https://test.pypi.org/

L'id√©e de la cr√©ation d'un package est de cr√©er une brique r√©utilisable de composants fonctionnels.

Cela peut √™tre par exemple la r√©utilisation de classes entre diff√©rents projets ou la sauvegarde d'un sous ensemble de fonctions utiles que vous aimez utiliser sur les diff√©rents projets sur lesquels vous travaillez.

Un package en python a cette forme :

```
projet
‚îú‚îÄ‚îÄ LICENSE
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ package
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îî‚îÄ‚îÄ t.py
‚îú‚îÄ‚îÄ  tests/
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ pyproject.toml
```

A la racine du package se trouve :

- un fichier pyproject.toml, qui contient des m√©tadonn√©es sur la version, le nom de l'application, etc..
  => Il s'agit d'un fichier python qui permet ensuite de construire un "livrable" au sens de python, pr√™t a √™tre envoy√©.
- Un fichier LICENSE pour pr√©ciser le mode d'usage et de partage du package
- un fichier README pour d√©crire l'usage

Puis il faut, dans cet ordre :

- construire le livrable (avec un outil comme `buildtools`)
- envoyer le livrable (avec un outil comme `twine`)


<div class="alert alert-info">
  <strong>Pour aller plus loin</strong> <br/> 
Comment packager un projet ? : <br/><a href="https://packaging.python.org/en/latest/tutorials/packaging-projects/">https://packaging.python.org/en/latest/tutorials/packaging-projects/</a>
</div>


## Travaux Pratiques

L'objectif de ce TP est de manipuler les √©l√©ments de packaging.
En effet, pour assurer la portabilit√© applicative, on sera amen√© a **canoniser** l'environnement d'execution de nos applicatifs.

**1 ) Modules python**
- Si vous ne l'avez pas fait, installez le package `helloensai` avec pip et lancez le via une commande python.
- Consultez les projets exemples : [1](https://github.com/conception-logicielle-ensai/archi-exemple) , [2](https://github.com/conception-logicielle-ensai/exemples-cours/tree/main/cours-3/gestionnaire-de-package/poetry-publish), [3](https://github.com/conception-logicielle-ensai/predicat). R√©pondez aux questions suivantes : est ce que le projet d√©taille comment arriver sur le projet? quel est le gestionnaire de paquet privil√©gi√© pour le projet ?

**2 ) Portabilit√© applicative**
- Dans un dossier bien choisi (par exemple votre projet ensai), cr√©ez un environnement virtuel et activez le.
- Veillez a √©viter que le venv soit non versionn√©.
- R√©fl√©chissez aux d√©pendances √©ventuelles pour former un fichier `requirements.txt` ou un fichier `pyproject.toml`

