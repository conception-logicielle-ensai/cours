---
url: /docs/configuration-code-environnement/
title: üîß Configuration du code en fonction de l'environnement
---

Lorsqu‚Äôon ex√©cute un programme, il est souvent n√©cessaire de le configurer, de le param√©trer ou de lui associer des √©l√©ments sp√©cifiques √† l‚Äôenvironnement depuis lequel il est lanc√©. Par exemple, il peut s‚Äôagir de travailler avec des donn√©es stock√©es dans un r√©pertoire particulier ou d‚Äôinjecter des param√®tres de connexion √† une base de donn√©es que l‚Äôon souhaite garder confidentiels et non versionn√©s.

Heureusement, il est possible d‚Äôinjecter dans un programme des variables externes, qui serviront √† configurer son comportement tout en restant ind√©pendantes du code source.

## Pourquoi externaliser la configuration d‚Äôun programme ?

Pour garantir la flexibilit√© et la s√©curit√© d‚Äôune application, il est souvent judicieux d‚Äôexternaliser certaines configurations. Voici quelques exemples courants :  

- **√âl√©ments d√©pendants de l‚Äôenvironnement cible** : Par exemple, l‚ÄôURL d‚Äôune base de donn√©es, un lien vers un jeu de donn√©es dans un datalake, le chemin d‚Äôun fichier externe, ou encore une r√®gle m√©tier configurable comme un seuil d‚Äôerreur.
- **Acc√®s s√©curis√© √† des ressources** : Les mots de passe ou cl√©s d‚Äôauthentification tel que les cl√©s d'API, ne doivent pas √™tre versionn√©s dans le code source pour √©viter tout risque de fuite.  


La configuration d‚Äôune application regroupe **tout ce qui est susceptible de varier entre diff√©rents environnements** (d√©veloppement, validation, production, etc.). Une bonne pratique consiste √† s√©parer strictement la configuration du code. Tandis que le code reste inchang√© √† travers les d√©ploiements, la configuration peut varier consid√©rablement.  

Un bon test pour s‚Äôassurer de cette s√©paration consiste √† se demander si l‚Äôapplication pourrait √™tre rendue open source √† tout moment, sans risquer de compromettre des identifiants ou d‚Äôautres donn√©es sensibles.

Cela peut √™tre mis en ≈ìuvre de plusieurs fa√ßons :  
- Par la lecture de variables d‚Äôenvironnement.  
- Par l‚Äôinjection de param√®tres lors du lancement du programme.  
- Par l‚Äôajout de fichiers de configuration situ√©s √† un emplacement connu et attendu par le programme.  

Ces trois techniques sont diff√©rentes interfaces pour **fournir des donn√©es au programme**, mais elles servent toutes le m√™me objectif : injecter des informations externes dans le code.  


**Ce qui reste le plus pr√©conis√©, c'est l'utilisation de variable d'environnement dans l'applicatif (cf https://12factor.net)**

Toutefois, les diff√©rentes m√©thodes d'injection existent et sont plus ou moins maintenues selon le language.



## Configuration par fichier de configuration externe

Dans de nombreux langages, il existe des formats sp√©cifiques pour g√©rer la configuration via des fichiers.  

En Python, les fichiers de configuration sont couramment utilis√©s, souvent dans des formats standardis√©s, parmi lesquels le format **TOML** (Tom‚Äôs Obvious, Minimal Language) et le format **INI**.  

### Exemple de fichier INI

```ini
# config.ini √† la racine du projet
[section_name]
key1 = value1
key2 = value2

[another_section]
keyA = valueA
keyB = valueB

# Exemple avec des param√®tres par d√©faut
[DEFAULT]
ServerAliveInterval = 45
Compression = yes
CompressionLevel = 9
ForwardX11 = yes

[forge.example]
User = hg

[topsecret.server.example]
Port = 50022
ForwardX11 = no
```

Dans la biblioth√®que standard de Python, on trouve le module **`configparser`**, qui permet de g√©rer des fichiers de configuration au format **INI**. Ces fichiers sont habituellement nomm√©s avec une extension descriptive comme `.ini`, et ce module permet √©galement de les lire facilement :  

```python
import configparser

# Cr√©ation d'un objet ConfigParser
config = configparser.ConfigParser()

# Lecture du fichier config.ini
config.read('config.ini')

# Exemple d‚Äôacc√®s aux donn√©es
server_interval = config['DEFAULT']['ServerAliveInterval']
user = config['forge.example']['User']
print(server_interval)  # Affiche : 45
print(user)             # Affiche : hg
```

<div class="alert alert-info">
  <strong> Pour aller plus loin </strong> <br/>Feuilleter la documentation <a href="https://docs.python.org/3/library/configparser.html">https://docs.python.org/3/library/configparser.html</a>
</div>


> **Note** :  
> Ce type de configuration est pr√©sent dans pratiquement tous les langages, bien que chaque langage ait ses conventions. Par exemple :  
> - En Java : `application.properties` ou `application.yml`  
> - En Node.js : `config.json`  
> - En Python : `.ini` (ou plus r√©cemment, `TOML`)  


## Configuration par arguments en ligne de commande

L'utilisation de la ligne de commande est une m√©thode historique pour g√©rer la configuration des programmes. Elle permet de cr√©er des variables de CLI (command-line interface), facilitant ainsi l'ex√©cution de programmes directement via le terminal.

De nombreux programmes informatiques, qu'ils soient con√ßus pour effectuer des t√¢ches rapidement (comme des scripts ou des outils en ligne de commande) ou pour fonctionner en arri√®re-plan en tant que serveurs (comme les serveurs web ou les bases de donn√©es), peuvent recevoir des param√®tres (variables) directement via la ligne de commande lorsque vous les ex√©cutez. En Python, il est possible de r√©cup√©rer ces param√®tres √† l'aide du module `sys`.

Prenons, par exemple, le fichier `main.py` que nous avons construit pr√©c√©demment. En ajoutant le code suivant :

```python
import sys
import logging

arguments = sys.argv
logging.basicConfig(filename=arguments[1], encoding='utf-8', level=logging.DEBUG)
```

et en lan√ßant la commande :  
`python main.py toto.log`  

nous pouvons √©crire les logs dans le fichier `toto.log`.

Cependant, un inconv√©nient de cette approche est qu'avec un nombre accru d'arguments, il devient plus facile de commettre des erreurs d'ordonnancement ou d'oublier un param√®tre.

<div class="alert alert-info">
  <strong> Pour aller plus loin </strong> <br/>Clique est une biblioth√®que pour Python qui facilite la cr√©ation d'interfaces en ligne de command <a href="https://click.palletsprojects.com/en/stable/">https://click.palletsprojects.com/en/stable/</a>
</div>

> √Ä noter que cette m√©thode ne sera pas approfondie ici, car nous nous concentrerons principalement sur la configuration par variables d'environnement.


## Gestion des variables d'environnement

Les variables d‚Äôenvironnement sont des variables disponibles dynamiquement pour votre programme pendant l‚Äôex√©cution. Contrairement √† des valeurs cod√©es en dur, elles sont adaptables √† l'environnement dans lequel l'application s'ex√©cute. Cela permet une plus grande flexibilit√© et facilite les √©ventuelles modifications de configuration.

L'injection par variable d'environnement est une solution optimale, notamment pour des personnes ext√©rieures au projet. Cette approche permet de surcharger facilement la configuration en renseignant des param√®tres sous la forme :

```
CLE=valeur
```

> **Remarque :** Les noms des variables d'environnement suivent la notation `UPPER_SNAKE_CASE`.

En Python, la gestion des variables d'environnement peut √™tre facilit√©e avec la librairie `python-dotenv`. Celle-ci permet de lire un fichier **.env** et d'exporter son contenu dans l'environnement d'ex√©cution.

#### Exemple d'un fichier .env
```
# Configuration par d√©faut
CHEMIN_FICHIER_LOG=
ENVIRONNEMENT=local
```
Voici comment importer les variables depuis un fichier .env :

```python
from dotenv import load_dotenv

# Charge toutes les variables d'environnement depuis le fichier .env
load_dotenv()
```

Une fois charg√©es, les variables sont accessibles via la librairie `os` :

```python
import os

chemin_fichier_log = os.getenv("CHEMIN_FICHIER_LOG")
environnement = os.getenv("ENVIRONNEMENT")
```

Il est √©galement possible de d√©finir plusieurs fichiers pour organiser les configurations et √©viter de versionner des donn√©es sensibles. Par exemple, vous pouvez charger un fichier local suppl√©mentaire :

```python
from dotenv import load_dotenv
import os

# Charge le fichier principal
load_dotenv()

# Charge un fichier local si pr√©sent
local_env_path = ".env.local"
if os.path.exists(local_env_path):
    load_dotenv(dotenv_path=local_env_path, override=True)
```

<div class="alert alert-info">
  <strong> Pour aller plus loin </strong> <br/>Variables d'environnement :  <a href="https://kinsta.com/knowledgebase/what-is-an-environment-variable/">https://kinsta.com/knowledgebase/what-is-an-environment-variable/</a>
</div>


## Travaux Pratiques

**OBJECTIF DU TP** : Cr√©ez un fichier `main.py` qui, au lancement de l'application, affiche dans les logs toutes les valeurs des variables d'environnement, √† l'exception des mots de passe.  

1. Cr√©ez un fichier `.env.local` contenant :  
   - Une fausse URL de base de donn√©es  
   - Un faux mot de passe de base de donn√©es
   - La version actuelle de votre application (par d√©faut, utilisez `0.1` si vous n'avez pas encore commenc√© votre projet).  

1. Cr√©ez un fichier `.env.template` qui liste toutes les variables pr√©sentes dans le fichier `.env.local`. Ce fichier servira de mod√®le pour permettre aux d√©veloppeurs de cr√©er leur propre fichier `.env` localement.  

1. Ajoutez le fichier `.env.local` au `.gitignore` pour √©viter qu'il soit versionn√©.  

1. Dans le fichier `main.py` :  
   - Impl√©mentez une m√©thode qui charge les variables d'environnement globales ainsi que celles du fichier local (si un fichier `.env.local` est pr√©sent).  

1. Ajoutez une m√©thode qui affiche toutes les variables d'environnement (globales et locales), en masquant les valeurs des variables dont le nom contient les mots-cl√©s suivants :  
   - `password`, `pwd`, `jeton`, `token`, `secret`, `key`, `cle`, `mdp`, ou `motdepasse`.  
   Pour ces variables, affichez des `****` √† la place de leur valeur.  

1. Cr√©ez une nouvelle version de votre code (en veillant √† ce que le fichier `.env.local` ne soit pas inclus dans la version). Envoyez ensuite cette version √† votre d√©p√¥t distant.